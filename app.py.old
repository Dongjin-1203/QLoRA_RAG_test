# """
# HuggingFace Spaceìš© ì‹¤í—˜ ì•±

# Gradioë¥¼ ì‚¬ìš©í•˜ì—¬ ì›¹ UIì—ì„œ ì‹¤í—˜ì„ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
# """

# import gradio as gr
# import os
# import json
# import pandas as pd
# from pathlib import Path
# import matplotlib.pyplot as plt
# from datetime import datetime

# # í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì •
# import sys
# sys.path.insert(0, str(Path(__file__).parent))

# from experiments.eval_dataset import EvalDataset
# from experiments.compare_models import ModelComparison
# from experiments.analyze_results import ResultAnalyzer


# class ExperimentApp:
#     """ì‹¤í—˜ ì•± í´ë˜ìŠ¤"""
    
#     def __init__(self):
#         self.experiment = None
#         self.latest_result_file = None
    
#     def setup_environment(self, api_key: str) -> str:
#         """í™˜ê²½ ì„¤ì •"""
#         if not api_key:
#             return "âŒ OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
        
#         os.environ['OPENAI_API_KEY'] = api_key
#         os.environ['USE_MODEL_HUB'] = 'true'
#         os.environ['GGUF_N_GPU_LAYERS'] = '35'
        
#         return "âœ… í™˜ê²½ ì„¤ì • ì™„ë£Œ!"
    
#     def run_experiment(
#         self, 
#         api_key: str, 
#         distribution: str,
#         progress=gr.Progress()
#     ) -> tuple:
#         """ì‹¤í—˜ ì‹¤í–‰"""
#         try:
#             # í™˜ê²½ ì„¤ì •
#             setup_msg = self.setup_environment(api_key)
#             if "âŒ" in setup_msg:
#                 return setup_msg, None, None
            
#             progress(0.1, desc="í™˜ê²½ ì„¤ì • ì™„ë£Œ...")
            
#             # Config ë¡œë“œ
#             from src.utils.config import RAGConfig
#             config = RAGConfig()
            
#             progress(0.2, desc="ì‹¤í—˜ ì´ˆê¸°í™” ì¤‘...")
            
#             # ì‹¤í—˜ ì´ˆê¸°í™”
#             self.experiment = ModelComparison(
#                 config=config, 
#                 output_dir="./experiments/results"
#             )
            
#             progress(0.3, desc="ëª¨ë¸ ë¡œë”© ì¤‘... (3-5ë¶„ ì†Œìš”)")
            
#             # ëª¨ë¸ ë¡œë“œ
#             self.experiment.load_models()
            
#             progress(0.5, desc="ì‹¤í—˜ ì‹¤í–‰ ì¤‘... (10-20ë¶„ ì†Œìš”)")
            
#             # ì‹¤í—˜ ì‹¤í–‰
#             results = self.experiment.run_experiment(
#                 distribution=distribution.lower(),
#                 save_results=True
#             )
            
#             progress(0.9, desc="ê²°ê³¼ ë¶„ì„ ì¤‘...")
            
#             # ìµœì‹  ê²°ê³¼ íŒŒì¼ ì°¾ê¸°
#             result_files = sorted(
#                 Path("./experiments/results").glob("results_*.json"),
#                 reverse=True
#             )
#             self.latest_result_file = str(result_files[0]) if result_files else None
            
#             # ìš”ì•½ ìƒì„±
#             summary = self._generate_summary(results)
            
#             # CSV ìƒì„±
#             df = self._results_to_dataframe(results)
            
#             progress(1.0, desc="ì™„ë£Œ!")
            
#             return "âœ… ì‹¤í—˜ ì™„ë£Œ!", summary, df
        
#         except Exception as e:
#             return f"âŒ ì‹¤í—˜ ì‹¤íŒ¨: {str(e)}", None, None
    
#     def _generate_summary(self, results: dict) -> str:
#         """ìš”ì•½ ìƒì„±"""
#         summary = "=" * 60 + "\n"
#         summary += "ì‹¤í—˜ ê²°ê³¼ ìš”ì•½\n"
#         summary += "=" * 60 + "\n\n"
        
#         metadata = results['metadata']
#         summary += f"íƒ€ì„ìŠ¤íƒ¬í”„: {metadata['timestamp']}\n"
#         summary += f"ë¶„í¬: {metadata['distribution']}\n"
#         summary += f"ëª¨ë¸: {', '.join(metadata['models'])}\n"
#         summary += f"ì´ ì§ˆë¬¸ ìˆ˜: {metadata['total_queries']}\n\n"
        
#         # ê° ë¶„í¬ë³„ ìš”ì•½
#         for dist_type, dist_results in results['results'].items():
#             summary += f"\n{'='*60}\n"
#             summary += f"{dist_type.upper()}\n"
#             summary += f"{'='*60}\n\n"
            
#             # ëª¨ë¸ë³„ í†µê³„
#             model_stats = {}
#             for result in dist_results:
#                 model = result['model']
#                 if model not in model_stats:
#                     model_stats[model] = []
#                 model_stats[model].append(result)
            
#             for model, model_results in model_stats.items():
#                 success_count = sum(1 for r in model_results if r['success'])
#                 avg_time = sum(r['elapsed_time'] for r in model_results if r['success']) / max(success_count, 1)
                
#                 summary += f"[{model}]\n"
#                 summary += f"  ì„±ê³µ: {success_count}/{len(model_results)}\n"
#                 summary += f"  í‰ê·  ì‹œê°„: {avg_time:.3f}ì´ˆ\n\n"
        
#         return summary
    
#     def _results_to_dataframe(self, results: dict) -> pd.DataFrame:
#         """ê²°ê³¼ë¥¼ DataFrameìœ¼ë¡œ ë³€í™˜"""
#         all_rows = []
        
#         for dist_type, dist_results in results['results'].items():
#             for result in dist_results:
#                 row = {
#                     'distribution': dist_type,
#                     'model': result['model'],
#                     'query': result['query'],
#                     'success': result['success'],
#                     'elapsed_time': result['elapsed_time'],
#                     'total_tokens': result.get('usage', {}).get('total_tokens', 0)
#                 }
#                 all_rows.append(row)
        
#         return pd.DataFrame(all_rows)
    
#     def analyze_results(self) -> tuple:
#         """ê²°ê³¼ ë¶„ì„"""
#         if not self.latest_result_file:
#             return "âŒ ë¨¼ì € ì‹¤í—˜ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.", None, None, None, None
        
#         try:
#             analyzer = ResultAnalyzer(self.latest_result_file)
            
#             # ê·¸ë˜í”„ ìƒì„±
#             analyzer.plot_time_comparison()
#             analyzer.plot_token_comparison()
#             analyzer.plot_rag_usage()
#             analyzer.plot_overfitting_analysis()
            
#             # ê·¸ë˜í”„ íŒŒì¼ ê²½ë¡œ
#             analysis_dir = Path(self.latest_result_file).parent / "analysis"
            
#             time_plot = str(analysis_dir / "time_comparison.png")
#             token_plot = str(analysis_dir / "token_comparison.png")
#             rag_plot = str(analysis_dir / "rag_usage.png")
#             overfitting_plot = str(analysis_dir / "overfitting_analysis.png")
            
#             return (
#                 "âœ… ë¶„ì„ ì™„ë£Œ!",
#                 time_plot if Path(time_plot).exists() else None,
#                 token_plot if Path(token_plot).exists() else None,
#                 rag_plot if Path(rag_plot).exists() else None,
#                 overfitting_plot if Path(overfitting_plot).exists() else None
#             )
        
#         except Exception as e:
#             return f"âŒ ë¶„ì„ ì‹¤íŒ¨: {str(e)}", None, None, None, None


# # Gradio ì¸í„°í˜ì´ìŠ¤ ìƒì„±
# def create_interface():
#     """Gradio ì¸í„°í˜ì´ìŠ¤ ìƒì„±"""
#     app = ExperimentApp()
    
#     with gr.Blocks(title="RFPilot ëª¨ë¸ ë¹„êµ ì‹¤í—˜") as demo:
#         gr.Markdown("""
#         # ğŸ”¬ RFPilot ëª¨ë¸ ë¹„êµ ì‹¤í—˜
        
#         3ê°€ì§€ ëª¨ë¸(QLoRA+RAG, QLoRA ë‹¨ë…, Base+RAG)ì˜ ì„±ëŠ¥ì„ ë¹„êµí•©ë‹ˆë‹¤.
        
#         âš ï¸ **ì£¼ì˜**: ì‹¤í—˜ ì‹¤í–‰ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤ (10-20ë¶„).
#         """)
        
#         with gr.Tab("ğŸš€ ì‹¤í—˜ ì‹¤í–‰"):
#             api_key_input = gr.Textbox(
#                 label="OpenAI API Key",
#                 type="password",
#                 placeholder="sk-..."
#             )
            
#             distribution_input = gr.Radio(
#                 choices=["All", "In", "Out"],
#                 value="All",
#                 label="ë¶„í¬ ì„ íƒ"
#             )
            
#             run_btn = gr.Button("ì‹¤í—˜ ì‹œì‘", variant="primary")
            
#             status_output = gr.Textbox(label="ìƒíƒœ", lines=2)
#             summary_output = gr.Textbox(label="ìš”ì•½", lines=20)
#             results_output = gr.Dataframe(label="ê²°ê³¼")
            
#             run_btn.click(
#                 fn=app.run_experiment,
#                 inputs=[api_key_input, distribution_input],
#                 outputs=[status_output, summary_output, results_output]
#             )
        
#         with gr.Tab("ğŸ“Š ê²°ê³¼ ë¶„ì„"):
#             analyze_btn = gr.Button("ë¶„ì„ ì‹œì‘", variant="primary")
            
#             analyze_status = gr.Textbox(label="ìƒíƒœ")
            
#             with gr.Row():
#                 time_plot = gr.Image(label="ì‘ë‹µ ì‹œê°„ ë¹„êµ")
#                 token_plot = gr.Image(label="í† í° ì‚¬ìš©ëŸ‰ ë¹„êµ")
            
#             with gr.Row():
#                 rag_plot = gr.Image(label="RAG ì‚¬ìš© íŒ¨í„´")
#                 overfitting_plot = gr.Image(label="ê³¼ì í•© ë¶„ì„")
            
#             analyze_btn.click(
#                 fn=app.analyze_results,
#                 outputs=[
#                     analyze_status,
#                     time_plot,
#                     token_plot,
#                     rag_plot,
#                     overfitting_plot
#                 ]
#             )
        
#         with gr.Tab("â„¹ï¸ ì •ë³´"):
#             gr.Markdown("""
#             ## ğŸ“‹ ë¹„êµ ëª¨ë¸
            
#             | ëª¨ë¸ | ì„¤ëª… |
#             |------|------|
#             | QLoRA + RAG | ê¸°ì¡´ ì„œë¹„ìŠ¤ (QLoRA fine-tuning + RAG) |
#             | QLoRA ë‹¨ë… | RAG ì œê±° (QLoRAë§Œ) |
#             | Base + RAG | PEFT ì œê±° (Base ëª¨ë¸ + RAG) |
            
#             ## ğŸ“Š ì¸¡ì • ì§€í‘œ
            
#             - **ê³¼ì í•©**: In-Distribution vs Out-Distribution ì„±ëŠ¥ ì°¨ì´
#             - **ë‹µë³€ ì†ë„**: í‰ê·  ì‘ë‹µ ì‹œê°„
#             - **í† í° ì‚¬ìš©ëŸ‰**: í‰ê·  í† í° ì†Œë¹„
#             - **RAG ì‚¬ìš© íŒ¨í„´**: RAG í™œìš©ë„
            
#             ## â±ï¸ ì˜ˆìƒ ì†Œìš” ì‹œê°„
            
#             - ëª¨ë¸ ë¡œë”©: 3-5ë¶„
#             - ì‹¤í—˜ ì‹¤í–‰: 10-20ë¶„ (25ê°œ ì§ˆë¬¸)
#             - ê²°ê³¼ ë¶„ì„: 1-2ë¶„
#             """)
    
#     return demo


# if __name__ == "__main__":
#     demo = create_interface()
#     demo.launch(share=True)